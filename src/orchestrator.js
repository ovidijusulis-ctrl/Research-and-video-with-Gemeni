#!/usr/bin/env node
/**
 * Ovi English School - Main Orchestrator
 * Full automated pipeline: News â†’ Script â†’ Audio â†’ Video â†’ Publish
 */

const { spawn } = require('child_process');
const fs = require('fs').promises;
const path = require('path');
require('dotenv').config();

// Import modules
const { getNewsForEpisode } = require('./news-fetcher');
const { adaptNewsForLevel } = require('./content-adapter');
const { generateMetadata, saveMetadata } = require('./metadata-generator');
const { scanEpisodes, saveFeed } = require('./rss-generator');

// Configuration
const OUTPUT_DIR = path.join(__dirname, '..', 'output');
const LEVELS = ['beginner']; // Add 'intermediate', 'advanced' later

/**
 * Run Python script for audio generation
 * Uses file-based input for reliability
 */
function generateAudio(script, outputDir, level) {
  return new Promise(async (resolve, reject) => {
    // Save script to temp file (more reliable than stdin)
    const tempFile = path.join(outputDir, '.temp-script.txt');
    await fs.writeFile(tempFile, script);

    const pythonScript = path.join(__dirname, 'audio-generator.py');

    const proc = spawn('python3', [pythonScript, tempFile, outputDir, level], {
      stdio: 'inherit',
      env: { ...process.env, PYTHONUNBUFFERED: '1' }
    });

    proc.on('close', async (code) => {
      // Clean up temp file
      try { await fs.unlink(tempFile); } catch (e) {}
      code === 0 ? resolve() : reject(new Error(`Audio failed (code ${code})`));
    });
  });
}

/**
 * Convert audio to video for YouTube
 */
function convertToVideo(audioPath, outputPath) {
  return new Promise((resolve, reject) => {
    const pythonScript = path.join(__dirname, 'video-converter.py');

    const process = spawn('python3', [pythonScript, audioPath, '-o', outputPath], {
      stdio: 'inherit'
    });

    process.on('close', (code) => {
      code === 0 ? resolve(outputPath) : reject(new Error('Video conversion failed'));
    });
  });
}

/**
 * Upload to YouTube
 */
async function uploadToYouTube(videoPath, metadata) {
  const { uploadVideo } = require('./youtube-uploader');
  return uploadVideo(videoPath, {
    title: metadata.youtube.title,
    description: metadata.youtube.description,
    tags: metadata.youtube.tags,
    category: metadata.youtube.category,
    privacy: metadata.youtube.privacy
  });
}

/**
 * Save files
 */
async function saveScript(script, outputDir, level, date) {
  const filepath = path.join(outputDir, `ovi-english-${level}-${date}-script.txt`);
  await fs.writeFile(filepath, script);
  return filepath;
}

async function saveTranscript(script, story, outputDir, level, date) {
  const transcript = `# Ovi English School - Episode Transcript

**Date:** ${date}
**Level:** ${level.charAt(0).toUpperCase() + level.slice(1)}
**Topic:** ${story.title}

---

## Episode Script

${script}

---

## Source
- ${story.source}: ${story.title}
- Link: ${story.link || 'N/A'}

---
*Generated by Ovi English School*
`;
  const filepath = path.join(outputDir, `ovi-english-${level}-${date}-transcript.md`);
  await fs.writeFile(filepath, transcript);
  return filepath;
}

/**
 * Extract vocabulary from script
 */
function extractVocabulary(script) {
  const vocabSection = script.match(/vocabulary[:\s]*([\s\S]*?)(?:\n\n|\n#|$)/i);
  if (vocabSection) {
    const words = vocabSection[1].match(/["']([^"']+)["']/g) || [];
    return words.map(w => w.replace(/["']/g, '')).slice(0, 10);
  }
  return ['vocabulary', 'learning', 'news'];
}

/**
 * Main pipeline
 */
async function runPipeline(options = {}) {
  const {
    skipAudio = false,
    skipVideo = false,
    skipYouTube = false,
    skipRSS = false,
    language = 'english'
  } = options;

  console.log('\n' + 'â•'.repeat(50));
  console.log('ğŸ“ OVI ENGLISH SCHOOL - Full Pipeline');
  console.log('â•'.repeat(50));

  const date = new Date().toISOString().split('T')[0];
  const episodeDir = path.join(OUTPUT_DIR, date);
  await fs.mkdir(episodeDir, { recursive: true });

  const results = { date, episodeDir, files: [], urls: {} };

  // â”â”â” STEP 1: Fetch News â”â”â”
  console.log('\nâ”Œâ”€ STEP 1: Fetch News');
  const stories = await getNewsForEpisode(language);
  const story = stories[0];
  console.log(`â””â”€ âœ… Got story: ${story.title.slice(0, 50)}...`);

  for (const level of LEVELS) {
    console.log(`\nâ”Œâ”€ STEP 2: Generate ${level} content`);

    // Generate script
    const script = await adaptNewsForLevel(story, level);
    await saveScript(script, episodeDir, level, date);
    await saveTranscript(script, story, episodeDir, level, date);
    console.log(`â”œâ”€ âœ… Script & transcript saved`);

    // Generate metadata
    const vocabulary = extractVocabulary(script);
    const metadata = saveMetadata(episodeDir, {
      date,
      level,
      topic: story.title,
      vocabulary,
      newsSource: story.source
    });
    console.log(`â””â”€ âœ… Metadata generated`);

    // â”â”â” STEP 3: Audio â”â”â”
    if (!skipAudio) {
      console.log(`\nâ”Œâ”€ STEP 3: Generate audio (Qwen3-TTS)`);
      try {
        await generateAudio(script, episodeDir, level);
        console.log(`â””â”€ âœ… Audio generated`);
      } catch (e) {
        console.log(`â””â”€ âš ï¸  Audio failed: ${e.message}`);
      }
    }

    // â”â”â” STEP 4: Video â”â”â”
    const audioPath = path.join(episodeDir, `ovi-english-${level}-${date}.mp3`);
    const videoPath = path.join(episodeDir, `ovi-english-${level}-${date}.mp4`);

    if (!skipVideo && !skipAudio) {
      console.log(`\nâ”Œâ”€ STEP 4: Convert to video`);
      try {
        await convertToVideo(audioPath, videoPath);
        console.log(`â””â”€ âœ… Video created`);
        results.files.push(videoPath);
      } catch (e) {
        console.log(`â””â”€ âš ï¸  Video failed: ${e.message}`);
      }
    }

    // â”â”â” STEP 5: YouTube Upload â”â”â”
    if (!skipYouTube && !skipVideo && !skipAudio) {
      console.log(`\nâ”Œâ”€ STEP 5: Upload to YouTube`);
      try {
        const ytResult = await uploadToYouTube(videoPath, metadata);
        if (ytResult.success) {
          console.log(`â””â”€ âœ… YouTube: ${ytResult.url}`);
          results.urls.youtube = ytResult.url;
          await fs.writeFile(path.join(episodeDir, 'youtube-url.txt'), ytResult.url);
        }
      } catch (e) {
        console.log(`â””â”€ âš ï¸  YouTube failed: ${e.message}`);
      }
    }
  }

  // â”â”â” STEP 6: Update RSS Feed â”â”â”
  if (!skipRSS) {
    console.log(`\nâ”Œâ”€ STEP 6: Update RSS feed`);
    const episodes = scanEpisodes(OUTPUT_DIR);
    const feedPath = path.join(__dirname, '..', 'feed.xml');
    saveFeed(feedPath, episodes);
    console.log(`â””â”€ âœ… RSS feed updated (${episodes.length} episodes)`);
  }

  // â”â”â” Summary â”â”â”
  console.log('\n' + 'â•'.repeat(50));
  console.log('âœ… PIPELINE COMPLETE');
  console.log('â•'.repeat(50));
  console.log(`ğŸ“‚ Output: ${episodeDir}`);
  if (results.urls.youtube) console.log(`ğŸ¬ YouTube: ${results.urls.youtube}`);
  console.log('ğŸ“¡ RSS: feed.xml ready for Spotify/Apple\n');

  return results;
}

/**
 * CLI
 */
async function main() {
  const args = process.argv.slice(2);

  if (args.includes('--help')) {
    console.log(`
Ovi English School - Full Automated Pipeline

Usage:
  npm start                  Run full pipeline
  npm start -- --skip-youtube   Skip YouTube upload
  npm start -- --skip-video     Skip video conversion
  npm start -- --skip-audio     Skip audio generation
  npm start -- --content-only   Only generate content (no audio/video)

Pipeline Steps:
  1. Fetch news from RSS feeds
  2. Generate educational script (Gemini AI)
  3. Create audio (Qwen3-TTS)
  4. Convert to video (FFmpeg)
  5. Upload to YouTube
  6. Update RSS feed for Spotify/Apple
`);
    return;
  }

  const options = {
    skipAudio: args.includes('--skip-audio') || args.includes('--content-only'),
    skipVideo: args.includes('--skip-video') || args.includes('--content-only'),
    skipYouTube: args.includes('--skip-youtube') || args.includes('--content-only'),
    skipRSS: args.includes('--skip-rss')
  };

  try {
    await runPipeline(options);
  } catch (error) {
    console.error('\nâŒ Pipeline failed:', error.message);
    process.exit(1);
  }
}

module.exports = { runPipeline };

if (require.main === module) {
  main();
}
